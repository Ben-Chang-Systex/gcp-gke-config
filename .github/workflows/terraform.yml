name: 'Terraform to GCP'

on:
  push:
    branches: [ "main" ]
  pull_request:

permissions:
  contents: read
  id-token: write # 這是為了 GCP Workload Identity 驗證必須加的

jobs:
  terraform:
    name: 'Terraform'
    runs-on: ubuntu-latest
    
    defaults:
      run:
        shell: bash

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # --- 新增：GCP 驗證步驟 ---
    - id: 'auth'
      name: 'Authenticate to Google Cloud'
      uses: 'google-github-actions/auth@v2'
      with:
        # 請填入您的 Workload Identity Provider 完整路徑
        workload_identity_provider: 'projects/186682394478/locations/global/workloadIdentityPools/github-pool/providers/github-network-provider'
        # 請填入您的 Service Account Email
        service_account: 'sa-github-network@b15d-gcplab-ben-412305.iam.gserviceaccount.com'

    # --- 修改：Setup Terraform (移除 cli_config_credentials_token) ---
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      # 這裡不需要 token 了，因為我們用 GCS backend + gcloud auth

    - name: Terraform Init
      run: terraform init

    - name: Terraform Format
      run: terraform fmt -check

    - name: Terraform Plan
      run: terraform plan -input=false

    - name: Terraform Apply
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: terraform apply -auto-approve -input=false
